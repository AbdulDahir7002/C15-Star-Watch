
name: Deploy Workflow

on:
  workflow_run:
    workflows: ["PyTest Workflow"]
    branches: [abdul-ec2-deploy]
    types: 
      - completed
  workflow_dispatch:

permissions:
  contents: write

jobs:
  dashboard-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: get code
        uses: actions/checkout@v4.2.2
      # - name: make pemkey
      #   run: |
      #     echo "${{ secrets.SSH_PRIVATE_KEY }}" > dashboard/.pemkey
      #     chmod 400 dashboard/.pemkey
      # - name: kill process
      #   run: |

      #     ssh -tt -i dashboard/.pemkey ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} <<EOF
      #     PID=$(pgrep -f "streamlit run")
      #     if [ ! -z "$PID" ]; then
      #     kill $PID
      #     else
      #     echo "No process running"
      #     fi 
      #     EOF
      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-rlgoDzvc -i"
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          SOURCE: "dashboard"
      # - name: start process
      #   run: |
      #     ssh -i dashboard/.pemkey ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} <<EOF
      #     cd dashboard
      #     nohup streamlit run main.py & 
      #     EOF

